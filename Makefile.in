all: $(TARGETS)

dcc: dcc-$(DCC_VER).tar.gz
	test -d dcc-dccd-$(DCC_VER) || ( tar xzf dcc-$(DCC_VER).tar.gz && \
	cd dcc-dccd-$(DCC_VER) && ./configure && make && \
	cd .. )

lex: $(LEX_SRC) $(YACC_SRC)
	$(LEX) -o$(LEX_OUTPUT) $(LEX_SRC)
	$(YACC) -d -o $(YACC_OUTPUT) $(YACC_SRC)

build: 
	@for src in $(SOURCES) ; do \
	echo $(CC) $(CFLAGS) $(PTHREAD_FLAGS) -c $$src ; \
	$(CC) $(CFLAGS) $(PTHREAD_FLAGS) -c $$src  || exit ; \
	done

link:
	$(CC) $(PTHREAD_FLAGS) $(LDFLAGS) $(OBJECTS) $(LIBS) -o $(EXEC)

memctest: upstream.c memcached.c memcached-test.c
	$(CC) $(CFLAGS) $(PTHREAD_FLAGS) -c upstream.c
	$(CC) $(CFLAGS) $(PTHREAD_FLAGS) -c memcached.c
	$(CC) $(CFLAGS) $(PTHREAD_FLAGS) -c memcached-test.c
	$(CC) $(PTHREAD_FLAGS) $(LD_PATH) upstream.o memcached.o memcached-test.o $(LIBS) -o memcached-test

install:
	$(INSTALL) -b $(EXEC) $(PREFIX)/sbin/$(EXEC)
	$(INSTALL) -v $(EXEC).sh $(PREFIX)/etc/rc.d
	$(INSTALL) -m0644 rmilter-grey.conf $(PREFIX)/etc/rmilter-grey.conf.sample
	$(INSTALL) -m0644 rmilter.conf.sample $(PREFIX)/etc
	$(MKDIR) -o $(RMILTER_USER) -g $(RMILTER_GROUP) /var/run/rmilter

clean:
	rm -f *.o $(EXEC) *.core
	rm -f cfg_lex.c cfg_yacc.c cfg_yacc.h
	rm -fr dcc-dccd-$(DCC_VER)

dist-clean: clean
	rm -f Makefile

creategroup:
	@echo "Create group $(RMILTER_GROUP) before installing!" 

createuser:
	@echo "Create user $(RMILTER_USER) before installing!" 
